<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ph√¢n T√≠ch V·ªã Tr√≠ VƒÉn Ph√≤ng - Digital Unicorn ƒê√† N·∫µng</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background: #0f172a; color: #e2e8f0; }

        .header { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); padding: 20px 30px; border-bottom: 1px solid #334155; display: flex; align-items: center; gap: 16px; }
        .header h1 { font-size: 22px; font-weight: 700; color: #f8fafc; }
        .header .subtitle { font-size: 13px; color: #94a3b8; }
        .logo { width: 40px; height: 40px; background: linear-gradient(135deg, #6366f1, #8b5cf6); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }

        .layout { display: grid; grid-template-columns: 1fr 420px; height: calc(100vh - 76px); }
        @media (max-width: 900px) {
            .layout { grid-template-columns: 1fr; grid-template-rows: 50vh 1fr; }
        }

        #map { width: 100%; height: 100%; }

        .sidebar { background: #1e293b; border-left: 1px solid #334155; overflow-y: auto; }
        .sidebar::-webkit-scrollbar { width: 6px; }
        .sidebar::-webkit-scrollbar-track { background: #1e293b; }
        .sidebar::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

        .section { padding: 16px 20px; border-bottom: 1px solid #334155; }
        .section-title { font-size: 13px; font-weight: 600; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-card { background: #0f172a; border: 1px solid #334155; border-radius: 8px; padding: 12px; }
        .stat-value { font-size: 24px; font-weight: 700; color: #f8fafc; }
        .stat-label { font-size: 11px; color: #64748b; margin-top: 2px; }
        .stat-card.highlight { border-color: #6366f1; background: linear-gradient(135deg, #1e1b4b 0%, #0f172a 100%); }
        .stat-card.highlight .stat-value { color: #a5b4fc; }

        .office-card { background: #0f172a; border: 1px solid #334155; border-radius: 10px; padding: 14px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; position: relative; }
        .office-card:hover { border-color: #6366f1; transform: translateY(-1px); }
        .office-card.current { border-color: #22c55e; background: linear-gradient(135deg, #052e16 0%, #0f172a 100%); }
        .office-card.best { border-color: #f59e0b; }
        .office-card.selected { border-color: #6366f1; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3); }

        .office-name { font-size: 14px; font-weight: 600; color: #f8fafc; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .office-address { font-size: 12px; color: #64748b; margin-bottom: 10px; }
        .office-grade { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 600; }
        .grade-A { background: #166534; color: #86efac; }
        .grade-B { background: #1e40af; color: #93c5fd; }
        .grade-C { background: #713f12; color: #fcd34d; }

        .badge { font-size: 10px; padding: 2px 8px; border-radius: 10px; font-weight: 600; }
        .badge-current { background: #166534; color: #86efac; }
        .badge-best { background: #78350f; color: #fcd34d; }

        .office-metrics { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .metric { text-align: center; }
        .metric-value { font-size: 16px; font-weight: 700; }
        .metric-label { font-size: 10px; color: #64748b; }
        .metric-good { color: #4ade80; }
        .metric-ok { color: #fbbf24; }
        .metric-bad { color: #f87171; }

        .impact-indicator { display: flex; align-items: center; gap: 4px; font-size: 11px; margin-top: 8px; }
        .impact-low { color: #4ade80; }
        .impact-medium { color: #fbbf24; }
        .impact-high { color: #f87171; }

        .add-office { background: transparent; border: 2px dashed #334155; border-radius: 10px; padding: 14px; text-align: center; cursor: pointer; color: #64748b; font-size: 13px; transition: all 0.2s; width: 100%; }
        .add-office:hover { border-color: #6366f1; color: #a5b4fc; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 24px; width: 400px; max-width: 95vw; }
        .modal h3 { font-size: 16px; margin-bottom: 16px; color: #f8fafc; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-size: 12px; color: #94a3b8; margin-bottom: 4px; }
        .form-group input, .form-group select { width: 100%; padding: 8px 12px; background: #0f172a; border: 1px solid #334155; border-radius: 6px; color: #e2e8f0; font-size: 13px; }
        .form-group input:focus, .form-group select:focus { border-color: #6366f1; outline: none; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; }
        .btn-primary { background: #6366f1; color: white; }
        .btn-primary:hover { background: #4f46e5; }
        .btn-secondary { background: #334155; color: #e2e8f0; }
        .btn-secondary:hover { background: #475569; }
        .btn-group { display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px; }

        .employee-dist-chart { margin-top: 12px; }
        .dist-bar-row { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .dist-bar-label { font-size: 11px; color: #94a3b8; width: 70px; text-align: right; flex-shrink: 0; }
        .dist-bar-track { flex: 1; height: 16px; background: #0f172a; border-radius: 3px; overflow: hidden; position: relative; }
        .dist-bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s; display: flex; align-items: center; padding-left: 6px; }
        .dist-bar-count { font-size: 10px; color: rgba(255,255,255,0.8); font-weight: 600; }

        .comparison-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .comparison-table th { text-align: left; padding: 6px 8px; color: #94a3b8; font-weight: 600; border-bottom: 1px solid #334155; }
        .comparison-table td { padding: 6px 8px; border-bottom: 1px solid #1e293b; }
        .comparison-table tr:hover { background: rgba(99, 102, 241, 0.1); }

        .rank-badge { display: inline-flex; width: 22px; height: 22px; align-items: center; justify-content: center; border-radius: 50%; font-size: 11px; font-weight: 700; }
        .rank-1 { background: #fbbf24; color: #1e293b; }
        .rank-2 { background: #94a3b8; color: #1e293b; }
        .rank-3 { background: #b45309; color: #fff; }
        .rank-other { background: #334155; color: #94a3b8; }

        .legend { display: flex; gap: 16px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 11px; color: #94a3b8; }
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; }

        .tabs { display: flex; gap: 0; border-bottom: 1px solid #334155; }
        .tab { padding: 10px 16px; font-size: 12px; font-weight: 600; color: #64748b; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .tab:hover { color: #94a3b8; }
        .tab.active { color: #a5b4fc; border-bottom-color: #6366f1; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .tooltip-custom { background: #1e293b !important; border: 1px solid #334155 !important; color: #e2e8f0 !important; border-radius: 8px !important; padding: 8px 12px !important; font-size: 12px !important; }

        .filter-bar { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
        .filter-chip { padding: 4px 10px; font-size: 11px; border-radius: 20px; border: 1px solid #334155; background: transparent; color: #94a3b8; cursor: pointer; transition: all 0.2s; }
        .filter-chip:hover, .filter-chip.active { border-color: #6366f1; color: #a5b4fc; background: rgba(99, 102, 241, 0.1); }

        .delete-btn { position: absolute; top: 8px; right: 8px; width: 20px; height: 20px; border-radius: 50%; border: none; background: #334155; color: #94a3b8; font-size: 12px; cursor: pointer; display: none; align-items: center; justify-content: center; }
        .office-card:hover .delete-btn.custom { display: flex; }

        .lang-switch { margin-left: auto; display: flex; gap: 4px; }
        .lang-btn { padding: 4px 10px; font-size: 11px; border-radius: 6px; border: 1px solid #334155; background: transparent; color: #94a3b8; cursor: pointer; transition: all 0.2s; }
        .lang-btn:hover, .lang-btn.active { border-color: #6366f1; color: #a5b4fc; background: rgba(99, 102, 241, 0.1); }
    </style>
</head>
<body>

<div class="header">
    <div class="logo">üè¢</div>
    <div>
        <h1 id="h-title">Ph√¢n T√≠ch V·ªã Tr√≠ VƒÉn Ph√≤ng</h1>
        <div class="subtitle" id="h-subtitle">Digital Unicorn - ƒê√† N·∫µng | 83 nh√¢n vi√™n ƒë∆∞·ª£c ph√¢n t√≠ch</div>
    </div>
    <div class="lang-switch">
        <button class="lang-btn active" onclick="setLang('vi')">VN</button>
        <button class="lang-btn" onclick="setLang('fr')">FR</button>
    </div>
</div>

<div class="layout">
    <div id="map"></div>
    <div class="sidebar">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('overview')" id="tab-btn-overview">T·ªïng quan</div>
            <div class="tab" onclick="switchTab('ranking')" id="tab-btn-ranking">X·∫øp h·∫°ng</div>
            <div class="tab" onclick="switchTab('detail')" id="tab-btn-detail">Chi ti·∫øt</div>
        </div>

        <!-- OVERVIEW TAB -->
        <div id="tab-overview" class="tab-content active">
            <div class="section">
                <div class="section-title" data-i18n="globalStats">Th·ªëng k√™ t·ªïng quan</div>
                <div class="stats-grid">
                    <div class="stat-card highlight">
                        <div class="stat-value" id="total-employees">83</div>
                        <div class="stat-label" data-i18n="employeesMapped">Nh√¢n vi√™n ƒë√£ ƒë·ªãnh v·ªã</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-offices">0</div>
                        <div class="stat-label" data-i18n="officesAnalyzed">VƒÉn ph√≤ng ƒë∆∞·ª£c ph√¢n t√≠ch</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avg-current">-</div>
                        <div class="stat-label" data-i18n="avgDistCurrent">KC trung b√¨nh hi·ªán t·∫°i (km)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avg-best">-</div>
                        <div class="stat-label" data-i18n="bestAvgDist">KC trung b√¨nh t·ªët nh·∫•t</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title" data-i18n="legend">Ch√∫ gi·∫£i</div>
                <div class="legend">
                    <div class="legend-item"><div class="legend-dot" style="background:#6366f1"></div> <span data-i18n="employees">Nh√¢n vi√™n</span></div>
                    <div class="legend-item"><div class="legend-dot" style="background:#22c55e"></div> <span data-i18n="currentOffice">VP hi·ªán t·∫°i</span></div>
                    <div class="legend-item"><div class="legend-dot" style="background:#f59e0b"></div> <span data-i18n="bestChoice">L·ª±a ch·ªçn t·ªët nh·∫•t</span></div>
                    <div class="legend-item"><div class="legend-dot" style="background:#ef4444"></div> <span data-i18n="otherOptions">C√°c l·ª±a ch·ªçn kh√°c</span></div>
                </div>
            </div>

            <div class="section">
                <div class="section-title" data-i18n="officeOptions">C√°c l·ª±a ch·ªçn vƒÉn ph√≤ng</div>
                <div class="filter-bar">
                    <div class="filter-chip active" onclick="filterOffices('all')" data-i18n="all">T·∫•t c·∫£</div>
                    <div class="filter-chip" onclick="filterOffices('A')">H·∫°ng A</div>
                    <div class="filter-chip" onclick="filterOffices('B')">H·∫°ng B</div>
                    <div class="filter-chip" onclick="filterOffices('C')">H·∫°ng C</div>
                </div>
                <div class="filter-bar" style="margin-top:8px;">
                    <div class="filter-chip active" onclick="filterByPrice('all')" data-i18n="allPrices">T·∫•t c·∫£ gi√°</div>
                    <div class="filter-chip" onclick="filterByPrice('under100')">< 100M</div>
                    <div class="filter-chip" onclick="filterByPrice('100to200')">100-200M</div>
                    <div class="filter-chip" onclick="filterByPrice('over200')">> 200M</div>
                </div>
                <div id="office-list"></div>
                <button class="add-office" onclick="openAddModal()" id="btn-add-office">+ Th√™m vƒÉn ph√≤ng m·ªõi</button>
                <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
                    <button class="add-office" onclick="document.getElementById('import-file').click()" style="flex:1;" id="btn-import">
                        üì• Nh·∫≠p d·ªØ li·ªáu
                    </button>
                    <input type="file" id="import-file" accept=".json" style="display:none" onchange="importScrapedData(event)">
                </div>
            </div>
        </div>

        <!-- RANKING TAB -->
        <div id="tab-ranking" class="tab-content">
            <div class="section">
                <div class="section-title" data-i18n="globalRanking">X·∫øp h·∫°ng t·ªïng h·ª£p</div>
                <table class="comparison-table" id="ranking-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th data-i18n="office">VƒÉn ph√≤ng</th>
                            <th data-i18n="score">ƒêi·ªÉm</th>
                            <th data-i18n="price">Gi√°</th>
                            <th data-i18n="avgDist">KC TB</th>
                            <th>&lt;3km</th>
                            <th data-i18n="impact">·∫¢nh h∆∞·ªüng</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="section">
                <div class="section-title" data-i18n="distDistribution">Ph√¢n b·ªë kho·∫£ng c√°ch - VP hi·ªán t·∫°i</div>
                <div id="current-dist-chart" class="employee-dist-chart"></div>
            </div>
        </div>

        <!-- DETAIL TAB -->
        <div id="tab-detail" class="tab-content">
            <div class="section">
                <p style="color:#64748b; font-size:13px; text-align:center; padding:20px;" id="detail-placeholder">Nh·∫•p v√†o m·ªôt vƒÉn ph√≤ng ƒë·ªÉ xem chi ti·∫øt</p>
                <div id="detail-content"></div>
            </div>
        </div>
    </div>
</div>

<!-- ADD OFFICE MODAL -->
<div class="modal-overlay" id="add-modal">
    <div class="modal">
        <h3 id="modal-title">Th√™m vƒÉn ph√≤ng m·ªõi</h3>
        <div class="form-group">
            <label id="lbl-name">T√™n t√≤a nh√†</label>
            <input type="text" id="new-name" placeholder="VD: ABC Building">
        </div>
        <div class="form-group">
            <label id="lbl-address">ƒê·ªãa ch·ªâ</label>
            <input type="text" id="new-address" placeholder="VD: 123 Nguy·ªÖn VƒÉn Linh">
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Vƒ© ƒë·ªô (Latitude)</label>
                <input type="number" id="new-lat" step="0.0001" placeholder="16.05">
            </div>
            <div class="form-group">
                <label>Kinh ƒë·ªô (Longitude)</label>
                <input type="number" id="new-lng" step="0.0001" placeholder="108.22">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>H·∫°ng t√≤a nh√†</label>
                <select id="new-grade">
                    <option value="">-</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                </select>
            </div>
            <div class="form-group">
                <label id="lbl-rent">Gi√° thu√™ ∆∞·ªõc t√≠nh (VND/th√°ng)</label>
                <input type="number" id="new-price" placeholder="100000000">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label id="lbl-area">Di·ªán t√≠ch (m¬≤)</label>
                <input type="number" id="new-area" placeholder="400">
            </div>
            <div class="form-group">
                <label id="lbl-elevators">Thang m√°y</label>
                <input type="number" id="new-elevators" placeholder="2">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label id="lbl-year">NƒÉm x√¢y d·ª±ng</label>
                <input type="number" id="new-year" placeholder="2024">
            </div>
            <div class="form-group">
                <label id="lbl-floors">S·ªë t·∫ßng</label>
                <input type="number" id="new-floors" placeholder="1">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label id="lbl-months-market">Th·ªùi gian ƒëƒÉng (th√°ng)</label>
                <input type="number" id="new-months-market" placeholder="3">
            </div>
            <div class="form-group" style="display:flex;align-items:center;gap:8px;padding-top:20px;">
                <input type="checkbox" id="new-single-floor" style="width:auto;">
                <label for="new-single-floor" id="lbl-single-floor" style="margin:0;cursor:pointer;">M·ªôt t·∫ßng</label>
            </div>
        </div>
        <p style="font-size:11px; color:#64748b; margin-top:8px;" id="modal-tip">M·∫πo: Nh·∫•p v√†o b·∫£n ƒë·ªì ƒë·ªÉ t·ª± ƒë·ªông ƒëi·ªÅn t·ªça ƒë·ªô</p>
        <div class="btn-group">
            <button class="btn btn-secondary" onclick="closeAddModal()" id="btn-cancel">H·ªßy</button>
            <button class="btn btn-primary" onclick="addOffice()" id="btn-add">Th√™m</button>
        </div>
    </div>
</div>

<script>
// ============ i18n ============
let currentLang = 'vi';

const translations = {
    vi: {
        title: "Ph√¢n T√≠ch V·ªã Tr√≠ VƒÉn Ph√≤ng",
        subtitle: "Digital Unicorn - ƒê√† N·∫µng | 83 nh√¢n vi√™n ƒë∆∞·ª£c ph√¢n t√≠ch",
        tabOverview: "T·ªïng quan",
        tabRanking: "X·∫øp h·∫°ng",
        tabDetail: "Chi ti·∫øt",
        globalStats: "Th·ªëng k√™ t·ªïng quan",
        employeesMapped: "Nh√¢n vi√™n ƒë√£ ƒë·ªãnh v·ªã",
        officesAnalyzed: "VƒÉn ph√≤ng ƒë∆∞·ª£c ph√¢n t√≠ch",
        avgDistCurrent: "KC trung b√¨nh hi·ªán t·∫°i (km)",
        bestAvgDist: "KC trung b√¨nh t·ªët nh·∫•t",
        legend: "Ch√∫ gi·∫£i",
        employees: "Nh√¢n vi√™n",
        currentOffice: "VP hi·ªán t·∫°i",
        bestChoice: "L·ª±a ch·ªçn t·ªët nh·∫•t",
        otherOptions: "C√°c l·ª±a ch·ªçn kh√°c",
        officeOptions: "C√°c l·ª±a ch·ªçn vƒÉn ph√≤ng",
        all: "T·∫•t c·∫£",
        globalRanking: "X·∫øp h·∫°ng t·ªïng h·ª£p",
        office: "VƒÉn ph√≤ng",
        score: "ƒêi·ªÉm",
        avgDist: "KC TB",
        impact: "·∫¢nh h∆∞·ªüng",
        distDistribution: "Ph√¢n b·ªë kho·∫£ng c√°ch - VP hi·ªán t·∫°i",
        detailPlaceholder: "Nh·∫•p v√†o m·ªôt vƒÉn ph√≤ng ƒë·ªÉ xem chi ti·∫øt",
        addOfficeBtn: "+ Th√™m vƒÉn ph√≤ng m·ªõi",
        modalTitle: "Th√™m vƒÉn ph√≤ng m·ªõi",
        lblName: "T√™n t√≤a nh√†",
        lblAddress: "ƒê·ªãa ch·ªâ",
        lblRent: "Gi√° thu√™ ∆∞·ªõc t√≠nh (VND/th√°ng)",
        lblArea: "Di·ªán t√≠ch (m¬≤)",
        lblElevators: "Thang m√°y",
        modalTip: "M·∫πo: Nh·∫•p v√†o b·∫£n ƒë·ªì ƒë·ªÉ t·ª± ƒë·ªông ƒëi·ªÅn t·ªça ƒë·ªô",
        btnCancel: "H·ªßy",
        btnAdd: "Th√™m",
        badgeCurrent: "Hi·ªán t·∫°i",
        badgeBest: "ƒê·ªÅ xu·∫•t",
        avgDistKm: "KC TB (km)",
        scoreLabel: "ƒêi·ªÉm /100",
        lowImpact: "√çt ·∫£nh h∆∞·ªüng",
        mediumImpact: "·∫¢nh h∆∞·ªüng v·ª´a",
        highImpact: "·∫¢nh h∆∞·ªüng l·ªõn",
        employeesAffected: "nh√¢n vi√™n b·ªã ·∫£nh h∆∞·ªüng",
        impactLow: "Th·∫•p",
        impactMedium: "V·ª´a",
        impactHigh: "Cao",
        // Detail
        avgDistance: "Kho·∫£ng c√°ch trung b√¨nh",
        medianDistance: "Kho·∫£ng c√°ch trung v·ªã",
        minDist: "KC g·∫ßn nh·∫•t (km)",
        maxDist: "KC xa nh·∫•t (km)",
        avgDistLabel: "KC trung b√¨nh (km)",
        medianDistLabel: "KC trung v·ªã (km)",
        coverage: "Ph·∫°m vi ph·ª•c v·ª•",
        comparisonTitle: "So s√°nh v·ªõi VP hi·ªán t·∫°i",
        employeesLabel: "nh√¢n vi√™n",
        shorterCommute: "ƒêi l√†m g·∫ßn h∆°n",
        sameCommute: "T∆∞∆°ng t·ª±",
        longerCommute: "ƒêi l√†m xa h∆°n",
        avgChange: "Thay ƒë·ªïi trung b√¨nh",
        employeesUnder3km: "NV < 3km",
        buildingInfo: "Th√¥ng tin t√≤a nh√†",
        monthlyRent: "Ti·ªÅn thu√™/th√°ng",
        area: "Di·ªán t√≠ch",
        elevators: "Thang m√°y",
        yearBuilt: "NƒÉm x√¢y d·ª±ng",
        grade: "H·∫°ng",
        pricePerM2: "Gi√° / m¬≤",
        distDistLabel: "Ph√¢n b·ªë kho·∫£ng c√°ch",
        deleteConfirm: "X√≥a vƒÉn ph√≤ng n√†y?",
        fillRequired: "Vui l√≤ng ƒëi·ªÅn t√™n v√† t·ªça ƒë·ªô (nh·∫•p v√†o b·∫£n ƒë·ªì)",
        addressNotSpecified: "ƒê·ªãa ch·ªâ ch∆∞a x√°c ƒë·ªãnh",
        tooltipAvg: "KC TB",
        price: "Gi√°",
        priceRange: "Kho·∫£ng gi√°",
        allPrices: "T·∫•t c·∫£ gi√°",
        under100m: "< 100M",
        from100to200m: "100-200M",
        over200m: "> 200M",
        timeOnMarket: "Th·ªùi gian ƒëƒÉng",
        monthsShort: "th√°ng",
        newListing: "M·ªõi ƒëƒÉng",
        longListing: "ƒê√£ l√¢u",
        singleFloorLabel: "M·ªôt t·∫ßng",
        multiFloorLabel: "Nhi·ªÅu t·∫ßng",
        buildingAge: "Tu·ªïi t√≤a nh√†",
        ageNew: "M·ªõi",
        ageOld: "C≈©",
        importScraped: "Nh·∫≠p d·ªØ li·ªáu",
        importFromFile: "Nh·∫≠p t·ª´ file",
        scrapedSource: "Ngu·ªìn",
        floorsLabel: "S·ªë t·∫ßng",
    },
    fr: {
        title: "Analyse de Localisation de Bureau",
        subtitle: "Digital Unicorn - Da Nang | 83 employ√©s analys√©s",
        tabOverview: "Vue d'ensemble",
        tabRanking: "Classement",
        tabDetail: "D√©tail",
        globalStats: "Statistiques globales",
        employeesMapped: "Employ√©s mapp√©s",
        officesAnalyzed: "Bureaux analys√©s",
        avgDistCurrent: "Dist. moy. actuelle (km)",
        bestAvgDist: "Meilleure dist. moy.",
        legend: "L√©gende",
        employees: "Employ√©s",
        currentOffice: "Bureau actuel",
        bestChoice: "Meilleur choix",
        otherOptions: "Autres options",
        officeOptions: "Options de bureau",
        all: "Tous",
        globalRanking: "Classement global",
        office: "Bureau",
        score: "Score",
        avgDist: "Dist. moy.",
        impact: "Impact",
        distDistribution: "Distribution des distances - Bureau actuel",
        detailPlaceholder: "Cliquez sur un bureau pour voir les d√©tails",
        addOfficeBtn: "+ Ajouter un bureau",
        modalTitle: "Ajouter un bureau",
        lblName: "Nom du b√¢timent",
        lblAddress: "Adresse",
        lblRent: "Loyer estim√© (VND/mois)",
        lblArea: "Surface (m¬≤)",
        lblElevators: "Ascenseurs",
        modalTip: "Astuce: cliquez sur la carte pour remplir lat/lng automatiquement",
        btnCancel: "Annuler",
        btnAdd: "Ajouter",
        badgeCurrent: "Actuel",
        badgeBest: "Recommand√©",
        avgDistKm: "Dist. moy (km)",
        scoreLabel: "Score /100",
        lowImpact: "Faible perturbation",
        mediumImpact: "Perturbation mod√©r√©e",
        highImpact: "Forte perturbation",
        employeesAffected: "employ√©s affect√©s",
        impactLow: "Faible",
        impactMedium: "Moyen",
        impactHigh: "Fort",
        avgDistance: "Distance moyenne",
        medianDistance: "Distance m√©diane",
        minDist: "Dist. min (km)",
        maxDist: "Dist. max (km)",
        avgDistLabel: "Dist. moyenne (km)",
        medianDistLabel: "Dist. m√©diane (km)",
        coverage: "Couverture",
        comparisonTitle: "Comparaison vs Bureau Actuel",
        employeesLabel: "employ√©s",
        shorterCommute: "Trajet plus court",
        sameCommute: "Trajet similaire",
        longerCommute: "Trajet plus long",
        avgChange: "Changement moyen",
        employeesUnder3km: "Employ√©s < 3km",
        buildingInfo: "Informations du b√¢timent",
        monthlyRent: "Loyer mensuel",
        area: "Surface",
        elevators: "Ascenseurs",
        yearBuilt: "Ann√©e construction",
        grade: "Grade",
        pricePerM2: "Prix / m¬≤",
        distDistLabel: "Distribution des distances",
        deleteConfirm: "Supprimer ce bureau ?",
        fillRequired: "Veuillez remplir le nom et les coordonn√©es (cliquez sur la carte)",
        addressNotSpecified: "Adresse non sp√©cifi√©e",
        tooltipAvg: "Dist. moy",
        price: "Prix",
        priceRange: "Fourchette de prix",
        allPrices: "Tous les prix",
        under100m: "< 100M",
        from100to200m: "100-200M",
        over200m: "> 200M",
        timeOnMarket: "Temps en location",
        monthsShort: "mois",
        newListing: "R√©cent",
        longListing: "Ancien",
        singleFloorLabel: "Un seul √©tage",
        multiFloorLabel: "Multi-√©tages",
        buildingAge: "√Çge du b√¢timent",
        ageNew: "R√©cent",
        ageOld: "Ancien",
        importScraped: "Importer donn√©es",
        importFromFile: "Importer fichier",
        scrapedSource: "Source",
        floorsLabel: "√âtages",
    }
};

function t(key) { return translations[currentLang][key] || key; }

function setLang(lang) {
    currentLang = lang;
    document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
    document.querySelector(`.lang-btn[onclick="setLang('${lang}')"]`).classList.add('active');

    // Update static elements
    document.getElementById('h-title').textContent = t('title');
    document.getElementById('h-subtitle').textContent = t('subtitle');
    document.getElementById('tab-btn-overview').textContent = t('tabOverview');
    document.getElementById('tab-btn-ranking').textContent = t('tabRanking');
    document.getElementById('tab-btn-detail').textContent = t('tabDetail');
    document.getElementById('btn-add-office').textContent = t('addOfficeBtn');
    document.getElementById('modal-title').textContent = t('modalTitle');
    document.getElementById('lbl-name').textContent = t('lblName');
    document.getElementById('lbl-address').textContent = t('lblAddress');
    document.getElementById('lbl-rent').textContent = t('lblRent');
    document.getElementById('lbl-area').textContent = t('lblArea');
    document.getElementById('lbl-elevators').textContent = t('lblElevators');
    document.getElementById('modal-tip').textContent = t('modalTip');
    document.getElementById('btn-cancel').textContent = t('btnCancel');
    document.getElementById('btn-add').textContent = t('btnAdd');
    document.getElementById('detail-placeholder').textContent = t('detailPlaceholder');
    document.getElementById('lbl-year').textContent = t('yearBuilt');
    document.getElementById('lbl-floors').textContent = t('floorsLabel');
    document.getElementById('lbl-months-market').textContent = t('timeOnMarket');
    document.getElementById('lbl-single-floor').textContent = t('singleFloorLabel');
    document.getElementById('btn-import').textContent = 'üì• ' + t('importScraped');

    // Update data-i18n elements
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (translations[currentLang][key]) el.textContent = translations[currentLang][key];
    });

    // Re-render dynamic content
    renderAll();
    if (selectedOfficeId) selectOffice(selectedOfficeId);
}

// ============ DATA ============
const employees = [
    {name:"280 Ph·∫°m C·ª± L∆∞·ª£ng",lat:16.0555194,lng:108.2376017},
    {name:"09 L√™ Qu√Ω ƒê√¥n",lat:16.0554723,lng:108.2214637},
    {name:"K448 Tr∆∞ng N·ªØ V∆∞∆°ng",lat:16.0508064,lng:108.2149198},
    {name:"51 T·ªëng Ph∆∞·ªõc Ph·ªï",lat:16.0463995,lng:108.222036},
    {name:"Nguy·ªÖn Ph∆∞·ªõc Nguy√™n",lat:16.0543902,lng:108.183477},
    {name:"138 Mai Th√∫c L√¢n",lat:16.0483578,lng:108.2433234},
    {name:"40 Nguy·ªÖn Thi·ªán K·∫ø",lat:16.0607672,lng:108.2380878},
    {name:"178 Minh M·∫°ng",lat:16.0168776,lng:108.255508},
    {name:"36 L√™ ƒê√¨nh Th√°m",lat:16.0499365,lng:108.2161953},
    {name:"288 ƒê. ƒêo√†n Khu√™",lat:16.0236681,lng:108.2449521},
    {name:"An Th∆∞·ª£ng 34",lat:16.0497714,lng:108.2451734},
    {name:"T·ªï 7 th√¥n D∆∞∆°ng S∆°n",lat:15.9690248,lng:108.1881983},
    {name:"66 ƒê·ªó Anh H√†n",lat:16.0820386,lng:108.234664},
    {name:"53 C√π Ch√≠nh Lan",lat:16.0650078,lng:108.1880683},
    {name:"14 Tri·ªáu N·ªØ V∆∞∆°ng",lat:16.067334,lng:108.2157586},
    {name:"51 ƒê∆∞·ªùng Th√†nh Vinh 1",lat:16.1054378,lng:108.2521156},
    {name:"Tr·∫ßn Cao V√¢n",lat:16.0711585,lng:108.1966584},
    {name:"26 An C∆∞ 2",lat:16.0678108,lng:108.2420284},
    {name:"H√≤a Qu√Ω",lat:15.982958,lng:108.2334189},
    {name:"231 Nguy·ªÖn C√¥ng Tr·ª©",lat:16.065845,lng:108.239339},
    {name:"5 ƒêa M·∫∑n ƒê√¥ng 1",lat:16.0264218,lng:108.2498799},
    {name:"X6R7+QJ4",lat:15.9918686,lng:108.2140164},
    {name:"Nh√† VH th√¥n ƒê√¥ng H√≤a",lat:15.9968106,lng:108.1940681},
    {name:"44 Phan ƒêƒÉng L∆∞u",lat:16.0373707,lng:108.2205651},
    {name:"19 L√™ ƒê√¨nh Th√°m",lat:16.0505274,lng:108.2162906},
    {name:"320 Hu·ª≥nh Ng·ªçc Hu·ªá",lat:16.0543287,lng:108.1880612},
    {name:"814/33 Tr·∫ßn Cao V√¢n",lat:16.0706401,lng:108.1837849},
    {name:"63/2 ƒê. Nguy·ªÖn ƒê√¨nh Chi·ªÉu",lat:16.0283545,lng:108.2445168},
    {name:"41 Nguy·ªÖn Thi·ªán K·∫ø",lat:16.0601944,lng:108.2386581},
    {name:"666 Tr∆∞ng N·ªØ V∆∞∆°ng",lat:16.0422985,lng:108.2059544},
    {name:"3627+3WH",lat:16.0501965,lng:108.2148504},
    {name:"78 Nguy·ªÖn Xu√¢n Kho√°t",lat:16.0703511,lng:108.2359156},
    {name:"Nh√† VH Th√¥n H∆∞·ªüng Ph∆∞·ªõc",lat:16.0772323,lng:108.0988132},
    {name:"19 Phong B·∫Øc 20",lat:16.009496,lng:108.1938274},
    {name:"Quang Ch√¢u",lat:15.977101,lng:108.1977188},
    {name:"64 Thanh Ngh·ªã",lat:16.0663381,lng:108.1587325},
    {name:"FPT Plaza 2",lat:15.9827071,lng:108.2600255},
    {name:"64 Cao H·ªìng L√£nh",lat:15.9867087,lng:108.2358959},
    {name:"44 ƒê. An M·ªπ",lat:16.0632288,lng:108.2310634},
    {name:"124 L√™ Ch√¢n",lat:16.0859401,lng:108.2336248},
    {name:"24 Tr∆∞ng N·ªØ V∆∞∆°ng",lat:16.0602721,lng:108.2225629},
    {name:"365R+V9G",lat:16.0597428,lng:108.2407752},
    {name:"19 Ch∆°n T√¢m 4",lat:16.0638925,lng:108.1610359},
    {name:"16 C·ªìn D·∫ßu 16",lat:16.0196802,lng:108.2230342},
    {name:"M·ªπ An",lat:16.0476897,lng:108.2466488},
    {name:"41 ƒê·∫∑ng Thai Mai",lat:16.0607741,lng:108.2107731},
    {name:"165 Nguy·ªÖn Kim",lat:15.9922016,lng:108.2101939},
    {name:"Qu√°n D√¨ √ô",lat:16.0851865,lng:108.1558337},
    {name:"04 T√¢n An 1",lat:16.037648,lng:108.2118052},
    {name:"C·ªï M√¢n 9",lat:16.0914694,lng:108.2405164},
    {name:"Chung c∆∞ H√≤a Kh√°nh",lat:16.0746563,lng:108.1348629},
    {name:"02 H√≤a Minh 10",lat:16.0817337,lng:108.1580803},
    {name:"100 Nguy·ªÖn L∆∞∆°ng B·∫±ng",lat:16.0752655,lng:108.1492159},
    {name:"Vivian Hotel",lat:16.0773009,lng:108.2427593},
    {name:"101 D∆∞∆°ng Tr√≠ Tr·∫°ch",lat:16.0727493,lng:108.2404047},
    {name:"03 H√† VƒÉn Tr√≠",lat:16.0280512,lng:108.2109067},
    {name:"72 H·∫£i Ph√≤ng",lat:16.0724801,lng:108.2183001},
    {name:"ƒêinh Th·ªã V√¢n",lat:16.0435115,lng:108.1878526},
    {name:"18 N·∫°i Hi√™n ƒê√¥ng 9",lat:16.092113,lng:108.2309409},
    {name:"35 ƒê√†o Duy Anh",lat:16.058896,lng:108.2102866},
    {name:"12 M·∫°c ƒêƒ©nh Chi",lat:16.0656548,lng:108.2158003},
    {name:"142 √Çu C∆°",lat:16.0710647,lng:108.1467448},
    {name:"B·ªù ƒê·∫±m 6",lat:15.9707111,lng:108.2126521},
    {name:"05 B√¨nh H√≤a 2",lat:16.0258385,lng:108.2134604},
    {name:"Ph·ªë Th·∫°c Gi√°n",lat:16.0597146,lng:108.2072241},
    {name:"ƒêi·ªán An",lat:15.8849763,lng:108.231763},
    {name:"18 ƒêo√†n Th·ªã ƒêi·ªÉm",lat:16.0666084,lng:108.2170608},
    {name:"Cty XD Vi·ªát V≈©",lat:16.0291743,lng:108.2250125},
    {name:"Nguy·ªÖn Xu√¢n Nhƒ©",lat:16.0311443,lng:108.2265785},
    {name:"32 ƒê. G√≤ N·∫£y 7",lat:16.0684983,lng:108.1655779},
    {name:"Ki·ªát 1 Nam Tr√¢n",lat:16.0579621,lng:108.1720662},
    {name:"60 L∆∞u Tr√πng ƒê.",lat:15.9866956,lng:108.2368847},
    {name:"06 ƒê. T√¥ Vƒ©nh Di·ªán",lat:16.0521922,lng:108.1768355},
    {name:"57 M·∫°c Thi√™n T√≠ch",lat:16.026043,lng:108.2395359},
    {name:"L√Ω Nh·∫≠t Quang/22",lat:16.096573,lng:108.2297521},
    {name:"6 Ch∆°n T√¢m 4",lat:16.0639961,lng:108.1612463},
    {name:"59 Loseby",lat:16.0738016,lng:108.2416211},
    {name:"168 Minh M·∫°ng",lat:16.0071857,lng:108.2407986},
    {name:"5 T√¥ Hi·∫øn Th√†nh",lat:16.0641074,lng:108.2416558},
    {name:"124 Nguy·ªÖn Th·ªã ƒê·ªãnh",lat:16.0814079,lng:108.2308485},
    {name:"26 √îng √çch Khi√™m",lat:16.0781524,lng:108.2118695},
    {name:"74 Quang Trung",lat:16.0748524,lng:108.2193571},
    {name:"337 Nguy·ªÖn H·ªìng √Ånh",lat:15.9965627,lng:108.1968771}
];

let offices = [
    {id:"current",name:"VP Hi·ªán t·∫°i (96 H·ªì Nghinh)",address:"96 H·ªì Nghinh, An H·∫£i, S∆°n Tr√†",lat:16.0680,lng:108.2430,grade:"",isCurrent:true,price:null,area:null,elevators:null,year:null,monthsOnMarket:null,singleFloor:true,floorCount:1,custom:false},
    {id:"nhumai",name:"NH∆Ø MAI BUILDING",address:"328 Tr·∫ßn H∆∞ng ƒê·∫°o",lat:16.0607904,lng:108.2303821,grade:"C",isCurrent:false,price:132000000,area:400,elevators:1,year:2022,monthsOnMarket:4,singleFloor:false,floorCount:2,custom:false},
    {id:"x2",name:"X2 OFFICE",address:"666 Ng√¥ Quy·ªÅn",lat:16.0862718,lng:108.240397,grade:"C",isCurrent:false,price:40000000,area:205,elevators:1,year:2017,monthsOnMarket:8,singleFloor:true,floorCount:1,custom:false},
    {id:"nicholas",name:"NICHOLAS OFFICE",address:"482 Nguy·ªÖn H·ªØu Th·ªç",lat:16.0191879,lng:108.2115565,grade:"B",isCurrent:false,price:200000000,area:800,elevators:2,year:null,monthsOnMarket:2,singleFloor:false,floorCount:3,custom:false},
    {id:"vnpt",name:"VNPT 2/9",address:"344-346 ƒë∆∞·ªùng 2/9",lat:16.042017,lng:108.2229055,grade:"B",isCurrent:false,price:128000000,area:470,elevators:2,year:2012,monthsOnMarket:12,singleFloor:false,floorCount:2,custom:false},
    {id:"pdl125",name:"125 PHAN ƒêƒÇNG L∆ØU",address:"125 Phan ƒêƒÉng L∆∞u, H·∫£i Ch√¢u",lat:16.0374486,lng:108.2196587,grade:"C",isCurrent:false,price:183040000,area:320,elevators:2,year:2024,monthsOnMarket:1,singleFloor:false,floorCount:2,custom:false},
    {id:"div",name:"DIV (B·∫£o Hi·ªÉm Ti·ªÅn G·ª≠i)",address:"L√Ω Th√°nh T√¥ng, Thanh Kh√™",lat:16.0585,lng:108.1970,grade:"B",isCurrent:false,price:102000000,area:600,elevators:4,year:2025,monthsOnMarket:3,singleFloor:true,floorCount:1,custom:false},
    {id:"baold",name:"B√ÅO LAO ƒê·ªòNG",address:"X√¥ Vi·∫øt Ngh·ªá Tƒ©nh",lat:16.0318891,lng:108.2140287,grade:"B",isCurrent:false,price:50336000,area:220,elevators:2,year:2025,monthsOnMarket:6,singleFloor:true,floorCount:1,custom:false},
    {id:"shb",name:"SHB BUILDING",address:"06 Nguy·ªÖn VƒÉn Linh, H·∫£i Ch√¢u",lat:16.0613693,lng:108.2199779,grade:"B",isCurrent:false,price:205920000,area:600,elevators:2,year:null,monthsOnMarket:5,singleFloor:false,floorCount:2,custom:false}
];

let selectedOfficeId = null;
let mapClickMode = false;
let map, employeeLayer, officeMarkers = {};

// ============ HAVERSINE ============
function haversine(lat1, lng1, lat2, lng2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLng/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

// ============ COMPUTE STATS ============
function computeStats(office) {
    const distances = employees.map(e => haversine(e.lat, e.lng, office.lat, office.lng));
    distances.sort((a,b) => a - b);
    const avg = distances.reduce((s,d) => s+d, 0) / distances.length;
    const median = distances.length % 2 === 0 ? (distances[distances.length/2-1] + distances[distances.length/2]) / 2 : distances[Math.floor(distances.length/2)];
    const max = distances[distances.length-1];
    const min = distances[0];
    const within1 = distances.filter(d => d <= 1).length;
    const within2 = distances.filter(d => d <= 2).length;
    const within3 = distances.filter(d => d <= 3).length;
    const within5 = distances.filter(d => d <= 5).length;
    const within10 = distances.filter(d => d <= 10).length;
    const pct3 = (within3 / distances.length * 100);
    const pct5 = (within5 / distances.length * 100);
    const buckets = [
        { label: "0-1 km", count: within1, color: "#22c55e" },
        { label: "1-2 km", count: within2 - within1, color: "#4ade80" },
        { label: "2-3 km", count: within3 - within2, color: "#a3e635" },
        { label: "3-5 km", count: within5 - within3, color: "#fbbf24" },
        { label: "5-10 km", count: within10 - within5, color: "#f97316" },
        { label: "10+ km", count: distances.length - within10, color: "#ef4444" },
    ];
    return { distances, avg, median, max, min, within1, within2, within3, within5, within10, pct3, pct5, buckets };
}

// ============ SCORING ============
function computeScore(office, stats, currentStats) {
    const allStats = offices.map(o => computeStats(o));
    const avgMin = Math.min(...allStats.map(s => s.avg));
    const avgMax = Math.max(...allStats.map(s => s.avg));
    const medMin = Math.min(...allStats.map(s => s.median));
    const medMax = Math.max(...allStats.map(s => s.median));
    const maxMin = Math.min(...allStats.map(s => s.max));
    const maxMax = Math.max(...allStats.map(s => s.max));
    const normalize = (val, min, max) => max === min ? 1 : 1 - (val - min) / (max - min);

    // Distance average: 25%
    const avgScore = normalize(stats.avg, avgMin, avgMax) * 25;

    // % employees < 3km: 12%
    const pctScore = (stats.pct3 / 100) * 12;

    // Median distance: 8%
    const medScore = normalize(stats.median, medMin, medMax) * 8;

    // Impact (fewer negatively impacted = better): 10%
    let worse = 0;
    if (currentStats) {
        const currentOffice = offices.find(o => o.isCurrent);
        for (let i = 0; i < employees.length; i++) {
            const curDist = haversine(employees[i].lat, employees[i].lng, currentOffice.lat, currentOffice.lng);
            const newDist = haversine(employees[i].lat, employees[i].lng, office.lat, office.lng);
            if (newDist > curDist + 0.5) worse++;
        }
    }
    const impactScore = (1 - worse / employees.length) * 10;

    // Price: 20% (lower is better, normalized across all options with prices)
    let priceScore = 10; // default middle if no price
    const pricesAvailable = offices.filter(o => o.price > 0);
    if (office.price && pricesAvailable.length > 1) {
        const priceMin = Math.min(...pricesAvailable.map(o => o.price));
        const priceMax = Math.max(...pricesAvailable.map(o => o.price));
        priceScore = normalize(office.price, priceMin, priceMax) * 20;
    } else if (office.price && pricesAvailable.length === 1) {
        priceScore = 10;
    }

    // Year built: 8% (< 2 years old = bonus, > 10 years = penalty)
    let yearScore = 4; // default middle
    if (office.year) {
        const age = new Date().getFullYear() - office.year;
        if (age <= 2) yearScore = 8;
        else if (age <= 5) yearScore = 6;
        else if (age <= 10) yearScore = 4;
        else yearScore = 2;
    }

    // Time on market: 7% (< 3 months = great, > 6 = concern, > 12 = red flag)
    let marketScore = 3.5; // default middle
    if (office.monthsOnMarket !== null && office.monthsOnMarket !== undefined) {
        if (office.monthsOnMarket <= 3) marketScore = 7;
        else if (office.monthsOnMarket <= 6) marketScore = 5;
        else if (office.monthsOnMarket <= 12) marketScore = 3;
        else marketScore = 1;
    }

    // Single floor layout: 5% (single floor 500-600m2 = bonus)
    let floorScore = 2.5; // default middle
    if (office.singleFloor !== undefined && office.singleFloor !== null) {
        if (office.singleFloor && office.area >= 400 && office.area <= 700) {
            floorScore = 5; // ideal single floor
        } else if (office.singleFloor) {
            floorScore = 4; // single floor but not ideal size
        } else {
            floorScore = 1; // multi-floor penalty
        }
    }

    // Max distance: 5%
    const maxScore = normalize(stats.max, maxMin, maxMax) * 5;

    return Math.round(avgScore + pctScore + medScore + impactScore + priceScore + yearScore + marketScore + floorScore + maxScore);
}

// ============ CHANGE IMPACT ============
function computeImpact(office) {
    const current = offices.find(o => o.isCurrent);
    if (!current || office.isCurrent) return { better: 0, same: 0, worse: 0, avgChange: 0 };
    let better = 0, same = 0, worse = 0, totalChange = 0;
    employees.forEach(e => {
        const curDist = haversine(e.lat, e.lng, current.lat, current.lng);
        const newDist = haversine(e.lat, e.lng, office.lat, office.lng);
        const diff = newDist - curDist;
        totalChange += diff;
        if (diff < -0.3) better++;
        else if (diff > 0.3) worse++;
        else same++;
    });
    return { better, same, worse, avgChange: totalChange / employees.length };
}

// ============ MAP INIT ============
function initMap() {
    map = L.map('map').setView([16.055, 108.22], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    employeeLayer = L.layerGroup().addTo(map);
    employees.forEach(e => {
        const marker = L.circleMarker([e.lat, e.lng], {
            radius: 5, fillColor: '#6366f1', color: '#4338ca', weight: 1, fillOpacity: 0.7
        }).addTo(employeeLayer);
        marker.bindTooltip(e.name, { className: 'tooltip-custom' });
    });
    map.on('click', function(e) {
        if (mapClickMode) {
            document.getElementById('new-lat').value = e.latlng.lat.toFixed(6);
            document.getElementById('new-lng').value = e.latlng.lng.toFixed(6);
        }
    });
    renderOfficeMarkers();
}

function renderOfficeMarkers() {
    Object.values(officeMarkers).forEach(m => map.removeLayer(m));
    officeMarkers = {};
    const currentStats = computeStats(offices.find(o => o.isCurrent));
    const scored = offices.map(o => ({ ...o, stats: computeStats(o) }));
    scored.forEach(o => { o.score = computeScore(o, o.stats, currentStats); });
    const bestId = scored.filter(o => !o.isCurrent).sort((a,b) => b.score - a.score)[0]?.id;
    offices.forEach(o => {
        let color = '#ef4444', size = 8, zIndex = 100;
        if (o.isCurrent) { color = '#22c55e'; size = 10; zIndex = 200; }
        if (o.id === bestId) { color = '#f59e0b'; size = 10; zIndex = 200; }
        const icon = L.divIcon({
            className: '',
            html: `<div style="width:${size*2}px;height:${size*2}px;background:${color};border:2px solid white;border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,0.4);"></div>`,
            iconSize: [size*2, size*2], iconAnchor: [size, size]
        });
        const marker = L.marker([o.lat, o.lng], { icon, zIndexOffset: zIndex }).addTo(map);
        const stats = computeStats(o);
        marker.bindTooltip(`<b>${o.name}</b><br>${t('tooltipAvg')}: ${stats.avg.toFixed(1)} km<br>${stats.pct3.toFixed(0)}% < 3km`, { className: 'tooltip-custom' });
        marker.on('click', () => selectOffice(o.id));
        officeMarkers[o.id] = marker;
    });
}

// ============ RENDER UI ============
function renderAll() {
    const currentOffice = offices.find(o => o.isCurrent);
    const currentStats = currentOffice ? computeStats(currentOffice) : null;
    const scored = offices.map(o => {
        const stats = computeStats(o);
        const score = computeScore(o, stats, currentStats);
        const impact = computeImpact(o);
        return { ...o, stats, score, impact };
    });
    const bestOption = scored.filter(o => !o.isCurrent).sort((a,b) => b.score - a.score)[0];

    document.getElementById('total-employees').textContent = employees.length;
    document.getElementById('total-offices').textContent = offices.length;
    if (currentStats) document.getElementById('avg-current').textContent = currentStats.avg.toFixed(1);
    if (bestOption) document.getElementById('avg-best').textContent = bestOption.stats.avg.toFixed(1);

    const listEl = document.getElementById('office-list');
    listEl.innerHTML = '';
    scored.sort((a,b) => {
        if (a.isCurrent) return -1;
        if (b.isCurrent) return 1;
        return b.score - a.score;
    }).forEach(o => {
        const card = document.createElement('div');
        card.className = `office-card ${o.isCurrent ? 'current' : ''} ${o.id === bestOption?.id ? 'best' : ''} ${o.id === selectedOfficeId ? 'selected' : ''}`;
        card.setAttribute('data-grade', o.grade || '');
        card.onclick = () => selectOffice(o.id);

        let badges = '';
        if (o.isCurrent) badges += `<span class="badge badge-current">${t('badgeCurrent')}</span>`;
        if (o.id === bestOption?.id) badges += `<span class="badge badge-best">${t('badgeBest')}</span>`;
        if (o.grade) badges += `<span class="office-grade grade-${o.grade}">${o.grade}</span>`;

        // Time on market badge
        let marketBadge = '';
        if (o.monthsOnMarket !== null && o.monthsOnMarket !== undefined) {
            let mColor, mLabel;
            if (o.monthsOnMarket <= 3) { mColor = '#166534'; mLabel = `${o.monthsOnMarket} ${t('monthsShort')}`; }
            else if (o.monthsOnMarket <= 6) { mColor = '#854d0e'; mLabel = `${o.monthsOnMarket} ${t('monthsShort')}`; }
            else if (o.monthsOnMarket <= 12) { mColor = '#9a3412'; mLabel = `${o.monthsOnMarket} ${t('monthsShort')}`; }
            else { mColor = '#991b1b'; mLabel = `${o.monthsOnMarket} ${t('monthsShort')}`; }
            marketBadge = `<span class="badge" style="background:${mColor};color:#fef2f2">‚è± ${mLabel}</span>`;
        }

        // Floor indicator
        let floorBadge = '';
        if (o.singleFloor !== undefined && o.singleFloor !== null) {
            floorBadge = o.singleFloor
                ? `<span class="badge" style="background:#1e3a5f;color:#93c5fd">‚ñ¨ ${t('singleFloorLabel')}</span>`
                : `<span class="badge" style="background:#3b1f4b;color:#d8b4fe">‚ñ§ ${t('multiFloorLabel')} ${o.floorCount ? '('+o.floorCount+')' : ''}</span>`;
        }

        // Price display
        let priceBadge = '';
        if (o.price) {
            priceBadge = `<span class="badge" style="background:#1a1a2e;color:#a5b4fc;border:1px solid #334155">${(o.price/1000000).toFixed(0)}M VND</span>`;
        }

        // Source badge
        let sourceBadge = '';
        if (o.source) {
            sourceBadge = `<span class="badge" style="background:#1e293b;color:#64748b;border:1px solid #475569;font-size:9px;">üåê ${o.source}</span>`;
        }

        badges += marketBadge + floorBadge + priceBadge + sourceBadge;

        let impactHtml = '';
        if (!o.isCurrent) {
            const level = o.impact.worse > employees.length * 0.5 ? 'high' : o.impact.worse > employees.length * 0.3 ? 'medium' : 'low';
            const label = level === 'low' ? t('lowImpact') : level === 'medium' ? t('mediumImpact') : t('highImpact');
            const icon = level === 'low' ? '‚úì' : level === 'medium' ? '‚ö†' : '‚úï';
            impactHtml = `<div class="impact-indicator impact-${level}">${icon} ${label} (${o.impact.worse} ${t('employeesAffected')})</div>`;
        }
        const deleteBtn = o.custom ? `<button class="delete-btn custom" onclick="event.stopPropagation(); deleteOffice('${o.id}')">&times;</button>` : '';
        card.innerHTML = `
            ${deleteBtn}
            <div class="office-name">${o.name} ${badges}</div>
            <div class="office-address">${o.address}</div>
            <div class="office-metrics">
                <div class="metric">
                    <div class="metric-value ${o.stats.avg < 4 ? 'metric-good' : o.stats.avg < 6 ? 'metric-ok' : 'metric-bad'}">${o.stats.avg.toFixed(1)}</div>
                    <div class="metric-label">${t('avgDistKm')}</div>
                </div>
                <div class="metric">
                    <div class="metric-value ${o.stats.pct3 > 50 ? 'metric-good' : o.stats.pct3 > 30 ? 'metric-ok' : 'metric-bad'}">${o.stats.pct3.toFixed(0)}%</div>
                    <div class="metric-label">&lt; 3 km</div>
                </div>
                <div class="metric">
                    <div class="metric-value" style="color: ${scoreColor(o.score)}">${o.score}</div>
                    <div class="metric-label">${t('scoreLabel')}</div>
                </div>
            </div>
            ${impactHtml}
        `;
        listEl.appendChild(card);
    });

    // Ranking
    const tbody = document.querySelector('#ranking-table tbody');
    tbody.innerHTML = '';
    const ranked = scored.filter(o => !o.isCurrent).sort((a,b) => b.score - a.score);
    ranked.forEach((o, idx) => {
        const rankClass = idx < 3 ? `rank-${idx+1}` : 'rank-other';
        const tr = document.createElement('tr');
        tr.style.cursor = 'pointer';
        tr.onclick = () => { selectOffice(o.id); switchTab('detail'); };
        const impLevel = o.impact.worse > employees.length*0.5 ? 'high' : o.impact.worse > employees.length*0.3 ? 'medium' : 'low';
        const impLabel = impLevel === 'high' ? `‚ö† ${t('impactHigh')}` : impLevel === 'medium' ? `~ ${t('impactMedium')}` : `‚úì ${t('impactLow')}`;
        const priceStr = o.price ? `${(o.price/1000000).toFixed(0)}M` : '-';
        tr.innerHTML = `
            <td><span class="rank-badge ${rankClass}">${idx+1}</span></td>
            <td style="font-weight:600;color:#f8fafc;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${o.name}">${o.name}</td>
            <td style="color:${scoreColor(o.score)};font-weight:700">${o.score}</td>
            <td>${priceStr}</td>
            <td>${o.stats.avg.toFixed(1)}</td>
            <td>${o.stats.pct3.toFixed(0)}%</td>
            <td class="impact-${impLevel}">${impLabel}</td>
        `;
        tbody.appendChild(tr);
    });

    if (currentStats) renderDistChart('current-dist-chart', currentStats.buckets);
    renderOfficeMarkers();
}

function scoreColor(score) {
    if (score >= 70) return '#4ade80';
    if (score >= 50) return '#fbbf24';
    return '#f87171';
}

function renderDistChart(containerId, buckets) {
    const el = document.getElementById(containerId);
    if (!el) return;
    const maxCount = Math.max(...buckets.map(b => b.count), 1);
    el.innerHTML = buckets.map(b => `
        <div class="dist-bar-row">
            <div class="dist-bar-label">${b.label}</div>
            <div class="dist-bar-track">
                <div class="dist-bar-fill" style="width:${(b.count/maxCount)*100}%;background:${b.color}">
                    <span class="dist-bar-count">${b.count}</span>
                </div>
            </div>
        </div>
    `).join('');
}

// ============ SELECTION & DETAIL ============
function selectOffice(id) {
    selectedOfficeId = id;
    const office = offices.find(o => o.id === id);
    if (!office) return;
    map.setView([office.lat, office.lng], 13);
    document.querySelectorAll('.office-card').forEach(c => c.classList.remove('selected'));

    const stats = computeStats(office);
    const impact = computeImpact(office);
    const currentOffice = offices.find(o => o.isCurrent);
    const currentStats = currentOffice ? computeStats(currentOffice) : null;
    const score = computeScore(office, stats, currentStats);
    const detailEl = document.getElementById('detail-content');
    document.getElementById('detail-placeholder').style.display = 'none';

    let comparisonHtml = '';
    if (!office.isCurrent && currentStats) {
        const avgDiff = stats.avg - currentStats.avg;
        const pctDiff = stats.pct3 - currentStats.pct3;
        comparisonHtml = `
            <div style="margin-top:16px;">
                <div class="section-title">${t('comparisonTitle')}</div>
                <table class="comparison-table">
                    <tr><td>${t('avgDistance')}</td><td style="font-weight:700;color:${avgDiff<=0?'#4ade80':'#f87171'}">${avgDiff>0?'+':''}${avgDiff.toFixed(2)} km</td></tr>
                    <tr><td>${t('medianDistance')}</td><td style="font-weight:700;color:${stats.median<=currentStats.median?'#4ade80':'#f87171'}">${(stats.median - currentStats.median).toFixed(2)} km</td></tr>
                    <tr><td>${t('employeesUnder3km')}</td><td style="font-weight:700;color:${pctDiff>=0?'#4ade80':'#f87171'}">${pctDiff>0?'+':''}${pctDiff.toFixed(1)}%</td></tr>
                    <tr><td>${t('shorterCommute')}</td><td style="color:#4ade80;font-weight:700">${impact.better} ${t('employeesLabel')}</td></tr>
                    <tr><td>${t('sameCommute')}</td><td style="color:#fbbf24;font-weight:700">${impact.same} ${t('employeesLabel')}</td></tr>
                    <tr><td>${t('longerCommute')}</td><td style="color:#f87171;font-weight:700">${impact.worse} ${t('employeesLabel')}</td></tr>
                    <tr><td>${t('avgChange')}</td><td style="font-weight:700;color:${impact.avgChange<=0?'#4ade80':'#f87171'}">${impact.avgChange>0?'+':''}${impact.avgChange.toFixed(2)} km</td></tr>
                </table>
            </div>
        `;
    }

    let infoHtml = '';
    const infoItems = [];
    if (office.price) infoItems.push(`<tr><td>${t('monthlyRent')}</td><td style="font-weight:700">${(office.price/1000000).toFixed(0)}M VND</td></tr>`);
    if (office.area) infoItems.push(`<tr><td>${t('area')}</td><td style="font-weight:700">${office.area} m¬≤</td></tr>`);
    if (office.elevators) infoItems.push(`<tr><td>${t('elevators')}</td><td style="font-weight:700">${office.elevators}</td></tr>`);
    if (office.year) infoItems.push(`<tr><td>${t('yearBuilt')}</td><td style="font-weight:700">${office.year}</td></tr>`);
    if (office.floorCount) infoItems.push(`<tr><td>${t('floorsLabel')}</td><td style="font-weight:700">${office.floorCount}</td></tr>`);
    if (office.singleFloor !== null && office.singleFloor !== undefined) infoItems.push(`<tr><td>Layout</td><td style="font-weight:700">${office.singleFloor ? t('singleFloorLabel') : t('multiFloorLabel')}</td></tr>`);
    if (office.monthsOnMarket !== null && office.monthsOnMarket !== undefined) infoItems.push(`<tr><td>${t('timeOnMarket')}</td><td style="font-weight:700">${office.monthsOnMarket} ${t('monthsShort')}</td></tr>`);
    if (office.source) infoItems.push(`<tr><td>${t('scrapedSource')}</td><td style="font-weight:700"><a href="${office.sourceUrl || '#'}" target="_blank" style="color:#a5b4fc">${office.source}</a></td></tr>`);
    if (office.grade) infoItems.push(`<tr><td>${t('grade')}</td><td><span class="office-grade grade-${office.grade}">${office.grade}</span></td></tr>`);
    if (office.area && office.price) {
        infoItems.push(`<tr><td>${t('pricePerM2')}</td><td style="font-weight:700">${(office.price/office.area/1000).toFixed(0)}k VND</td></tr>`);
    }
    if (infoItems.length) {
        infoHtml = `<div style="margin-top:16px;"><div class="section-title">${t('buildingInfo')}</div><table class="comparison-table">${infoItems.join('')}</table></div>`;
    }

    detailEl.innerHTML = `
        <div style="text-align:center;margin-bottom:16px;">
            <h3 style="font-size:16px;color:#f8fafc;margin-bottom:4px;">${office.name}</h3>
            <div style="font-size:12px;color:#64748b;">${office.address}</div>
            <div style="font-size:48px;font-weight:800;margin:12px 0;color:${scoreColor(score)}">${score}<span style="font-size:16px;color:#64748b">/100</span></div>
        </div>
        <div class="stats-grid" style="margin-bottom:16px;">
            <div class="stat-card"><div class="stat-value" style="font-size:18px">${stats.avg.toFixed(2)}</div><div class="stat-label">${t('avgDistLabel')}</div></div>
            <div class="stat-card"><div class="stat-value" style="font-size:18px">${stats.median.toFixed(2)}</div><div class="stat-label">${t('medianDistLabel')}</div></div>
            <div class="stat-card"><div class="stat-value" style="font-size:18px">${stats.min.toFixed(2)}</div><div class="stat-label">${t('minDist')}</div></div>
            <div class="stat-card"><div class="stat-value" style="font-size:18px">${stats.max.toFixed(2)}</div><div class="stat-label">${t('maxDist')}</div></div>
        </div>
        <div class="section-title">${t('distDistLabel')}</div>
        <div id="detail-dist-chart" class="employee-dist-chart"></div>
        <div style="margin-top:16px;">
            <div class="section-title">${t('coverage')}</div>
            <table class="comparison-table">
                <tr><td>&lt; 1 km</td><td style="font-weight:700">${stats.within1} ${t('employeesLabel')} (${(stats.within1/employees.length*100).toFixed(0)}%)</td></tr>
                <tr><td>&lt; 2 km</td><td style="font-weight:700">${stats.within2} ${t('employeesLabel')} (${(stats.within2/employees.length*100).toFixed(0)}%)</td></tr>
                <tr><td>&lt; 3 km</td><td style="font-weight:700">${stats.within3} ${t('employeesLabel')} (${(stats.within3/employees.length*100).toFixed(0)}%)</td></tr>
                <tr><td>&lt; 5 km</td><td style="font-weight:700">${stats.within5} ${t('employeesLabel')} (${(stats.within5/employees.length*100).toFixed(0)}%)</td></tr>
                <tr><td>&lt; 10 km</td><td style="font-weight:700">${stats.within10} ${t('employeesLabel')} (${(stats.within10/employees.length*100).toFixed(0)}%)</td></tr>
            </table>
        </div>
        ${comparisonHtml}
        ${infoHtml}
    `;

    setTimeout(() => {
        const chartEl = document.getElementById('detail-dist-chart');
        if (chartEl) {
            const maxCount = Math.max(...stats.buckets.map(b => b.count), 1);
            chartEl.innerHTML = stats.buckets.map(b => `
                <div class="dist-bar-row">
                    <div class="dist-bar-label">${b.label}</div>
                    <div class="dist-bar-track">
                        <div class="dist-bar-fill" style="width:${(b.count/maxCount)*100}%;background:${b.color}">
                            <span class="dist-bar-count">${b.count}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }
    }, 10);

    drawLines(office);
    switchTab('detail');
}

let lineLayer = null;
function drawLines(office) {
    if (lineLayer) map.removeLayer(lineLayer);
    lineLayer = L.layerGroup().addTo(map);
    employees.forEach(e => {
        const dist = haversine(e.lat, e.lng, office.lat, office.lng);
        let color = '#22c55e';
        if (dist > 5) color = '#f97316';
        else if (dist > 3) color = '#fbbf24';
        else if (dist > 2) color = '#a3e635';
        L.polyline([[office.lat, office.lng], [e.lat, e.lng]], { color, weight: 1, opacity: 0.3 }).addTo(lineLayer);
    });
}

// ============ TABS ============
function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelector(`#tab-${tabName}`).classList.add('active');
    document.getElementById(`tab-btn-${tabName}`).classList.add('active');
}

// ============ FILTERS ============
function filterOffices(grade) {
    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
    event.target.classList.add('active');
    document.querySelectorAll('.office-card').forEach(card => {
        if (grade === 'all') card.style.display = '';
        else card.style.display = card.getAttribute('data-grade') === grade ? '' : 'none';
    });
}

function filterByPrice(range) {
    event.target.parentElement.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
    event.target.classList.add('active');
    document.querySelectorAll('.office-card').forEach(card => {
        if (range === 'all') { card.style.display = ''; return; }
        const office = offices.find(o => card.querySelector('.office-name')?.textContent.includes(o.name));
        if (!office || !office.price) { card.style.display = range === 'all' ? '' : 'none'; return; }
        const priceM = office.price / 1000000;
        let show = false;
        if (range === 'under100') show = priceM < 100;
        else if (range === '100to200') show = priceM >= 100 && priceM <= 200;
        else if (range === 'over200') show = priceM > 200;
        card.style.display = show ? '' : 'none';
    });
}

// ============ ADD/DELETE OFFICE ============
function openAddModal() {
    document.getElementById('add-modal').classList.add('active');
    mapClickMode = true;
}
function closeAddModal() {
    document.getElementById('add-modal').classList.remove('active');
    mapClickMode = false;
}
function addOffice() {
    const name = document.getElementById('new-name').value.trim();
    const address = document.getElementById('new-address').value.trim();
    const lat = parseFloat(document.getElementById('new-lat').value);
    const lng = parseFloat(document.getElementById('new-lng').value);
    const grade = document.getElementById('new-grade').value;
    const price = parseInt(document.getElementById('new-price').value) || null;
    const area = parseInt(document.getElementById('new-area').value) || null;
    const elevators = parseInt(document.getElementById('new-elevators').value) || null;
    const year = parseInt(document.getElementById('new-year').value) || null;
    const floorCount = parseInt(document.getElementById('new-floors').value) || null;
    const monthsOnMarket = parseInt(document.getElementById('new-months-market').value) || null;
    const singleFloor = document.getElementById('new-single-floor').checked;
    if (!name || isNaN(lat) || isNaN(lng)) { alert(t('fillRequired')); return; }
    offices.push({ id: 'custom_' + Date.now(), name, address: address || t('addressNotSpecified'), lat, lng, grade, isCurrent: false, price, area, elevators, year, floorCount, monthsOnMarket, singleFloor, custom: true });
    closeAddModal();
    renderAll();
    ['new-name','new-address','new-lat','new-lng','new-price','new-area','new-elevators','new-year','new-floors','new-months-market'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('new-grade').value = '';
    document.getElementById('new-single-floor').checked = false;
}
function deleteOffice(id) {
    if (!confirm(t('deleteConfirm'))) return;
    offices = offices.filter(o => o.id !== id);
    if (selectedOfficeId === id) selectedOfficeId = null;
    renderAll();
}

// ============ IMPORT SCRAPED DATA ============
function importScrapedData(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            if (!Array.isArray(data)) { alert('Invalid format: expected array'); return; }
            let added = 0, skipped = 0;
            data.forEach(item => {
                // Dedup by address proximity (within 100m)
                const isDuplicate = offices.some(o =>
                    haversine(o.lat, o.lng, item.lat, item.lng) < 0.1
                );
                if (isDuplicate) { skipped++; return; }
                offices.push({
                    id: 'scraped_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
                    name: item.name || 'Unknown',
                    address: item.address || t('addressNotSpecified'),
                    lat: item.lat,
                    lng: item.lng,
                    grade: item.grade || '',
                    isCurrent: false,
                    price: item.price || null,
                    area: item.area || null,
                    elevators: item.elevators || null,
                    year: item.year || null,
                    monthsOnMarket: item.monthsOnMarket || null,
                    singleFloor: item.singleFloor !== undefined ? item.singleFloor : null,
                    floorCount: item.floors || null,
                    custom: true,
                    source: item.source || null,
                    sourceUrl: item.sourceUrl || null
                });
                added++;
            });
            alert(`Imported: ${added} offices added, ${skipped} duplicates skipped`);
            renderAll();
        } catch(err) {
            alert('Error parsing JSON: ' + err.message);
        }
    };
    reader.readAsText(file);
}

// Auto-load scraped data on page load
function autoLoadScrapedData() {
    fetch('data/scraped_offices.json')
        .then(r => { if (r.ok) return r.json(); throw new Error('not found'); })
        .then(data => {
            if (!Array.isArray(data) || data.length === 0) return;
            let added = 0;
            data.forEach(item => {
                const isDuplicate = offices.some(o =>
                    haversine(o.lat, o.lng, item.lat, item.lng) < 0.1
                );
                if (isDuplicate) return;
                offices.push({
                    id: 'scraped_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
                    name: item.name || 'Unknown',
                    address: item.address || '',
                    lat: item.lat,
                    lng: item.lng,
                    grade: item.grade || '',
                    isCurrent: false,
                    price: item.price || null,
                    area: item.area || null,
                    elevators: item.elevators || null,
                    year: item.year || null,
                    monthsOnMarket: item.monthsOnMarket || null,
                    singleFloor: item.singleFloor !== undefined ? item.singleFloor : null,
                    floorCount: item.floors || null,
                    custom: true,
                    source: item.source || null,
                    sourceUrl: item.sourceUrl || null
                });
                added++;
            });
            if (added > 0) renderAll();
            console.log(`Auto-loaded ${added} scraped offices`);
        })
        .catch(() => { /* scraped data not available yet */ });
}

// ============ INIT ============
initMap();
renderAll();
autoLoadScrapedData();
</script>
</body>
</html>
